# SPDX-FileCopyrightText: Â© 2025 CoreWeave, Inc. <sunk@coreweave.com>

name: Release Orchestrator
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*coreweave.[0-9]+"

permissions:
  contents: read
  packages: read # Required for pulling the cw actions images

jobs:
  build-images:
    uses: ./.github/workflows/build-images.yaml
    with:
      target-repo-name: "slurm-containers-public"
    secrets: inherit
    permissions:
      contents: read # required for accessing the repo contents
      id-token: write # required for requesting JWT and OIDC tokens
      packages: write # Required for pulling the cw actions images

  publish:
    needs: [build-images]
    runs-on: cw
    container: registry.gitlab.com/coreweave/sunk/ci:v5.4.0-2024-12-27T21.13.49Z # TODO SUNK-622, replace this image
    permissions:
      contents: read
      id-token: write # Required for OIDC token generation
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Fix Git safe directory
        run: git config --global --add safe.directory "$(pwd)"
      - name: Build Registry Auth
        id: build-registry-auth
        env:
          CI_REGISTRY: docker.artifacts.coreweave.com
        uses: ./.github/actions/images/build-docker-config
        with:
          cloudsmith-service: ${{ vars.CLOUDSMITH_SERVICE }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish images
        env:
          AUTH_FILE: ${{ steps.build-registry-auth.outputs.docker_config_json_filename }}
          CI_REGISTRY: docker.artifacts.coreweave.com
        run: ci/publish.sh ${{ github.ref_name }}
