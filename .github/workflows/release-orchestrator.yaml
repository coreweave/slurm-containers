# (c) 2025 by CoreWeave, Inc.
#
# This file is part of Slurm Containers.
#
# Slurm Containers is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License,
# or (at your option) any later version.
#
# Slurm Containers is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with Slurm Containers; if not, write to the
# Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
# Boston, MA 02110-1301 USA

name: Release Orchestrator
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*coreweave.[0-9]+"

permissions:
  contents: read
  packages: read # Required for pulling the cw actions images

jobs:
  build-images:
    uses: ./.github/workflows/build-images.yaml
    with:
      target-repo-name: "${{ vars.CLOUDSMITH_REPO_NAME }}"
    secrets: inherit
    permissions:
      contents: read # required for accessing the repo contents
      id-token: write # required for requesting JWT and OIDC tokens
      packages: write # Required for pulling the cw actions images

  publish:
    needs: [build-images]
    runs-on: cw
    container: registry.gitlab.com/coreweave/sunk/ci:v5.4.0-2024-12-27T21.13.49Z # TODO SUNK-622, replace this image
    permissions:
      contents: read
      id-token: write # Required for OIDC token generation
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Fix Git safe directory
        run: git config --global --add safe.directory "$(pwd)"
      - name: Build Registry Auth
        id: build-registry-auth
        env:
          CI_REGISTRY: docker.artifacts.coreweave.com
        uses: ./.github/actions/images/build-docker-config
        with:
          cloudsmith-service: ${{ vars.CLOUDSMITH_SERVICE }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish images
        env:
          AUTH_FILE: ${{ steps.build-registry-auth.outputs.docker_config_json_filename }}
          CI_REGISTRY: docker.artifacts.coreweave.com
        run: ci/publish.sh ${{ github.ref_name }}
