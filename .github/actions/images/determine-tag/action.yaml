# (c) 2025 by CoreWeave, Inc.
#
# This file is part of Slurm Containers.
#
# Slurm Containers is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License,
# or (at your option) any later version.
#
# Slurm Containers is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with Slurm Containers; if not, write to the
# Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
# Boston, MA 02110-1301 USA

name: "Determine Tag"
description: "Determine the tag for SUNK images based on the commit SHA and any provided tag suffix."
inputs:
  tag-suffix:
    description: "Suffix to append to the tag."
    required: false
    default: ""

outputs:
  tag:
    description: "The computed image tag."
    value: ${{ steps.determine-tag.outputs.tag }}

runs:
  using: "composite"
  steps:
    # Github actions does not provide a short sha so we need to compute it
    - name: Determine Tag or SHA
      id: determine-tag
      shell: bash
      env:
        LAST_COMMIT_SHA: ${{ github.sha }}
      run: |
        _tag=${LAST_COMMIT_SHA:0:8}

        # Append suffix if provided
        if [ -n "${{ inputs.tag-suffix }}" ]; then
          _tag="${_tag}-${{ inputs.tag-suffix }}";
        fi

        echo "::debug::tag: ${_tag}"
        echo "::debug::tag-suffix: ${{ inputs.tag-suffix}}"

        echo "tag=${_tag}" >> $GITHUB_OUTPUT
